<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<MVATrainer xmlns:xi="http://www.w3.org/2001/XInclude">

        <general>
                <option name="id">TtSemiLepJetCombMVATrainer</option>
                <option name="trainfiles">train_%1$s%2$s.%3$s</option>
        </general>

	<xslt-input id="input" multiple="true" optional="false">
	        <xslt-varlist>
		        <var name="target"/>
		</xslt-varlist>
		<xi:include href="SemiLepJetCombMVATrainer_vars.xml"/>
	</xslt-input>

        <!-- the following processor defines that the subsequent 4 processors
             are called for each jetComb hypothesis separately in every event -->

	<xslt-ProcForeach id="loop" source="input" next="4">
	        <xslt-varlist>
		        <var name="target"/>
		</xslt-varlist>
		<xi:include href="SemiLepJetCombMVATrainer_vars.xml"/>
	</xslt-ProcForeach>

        <!-- create target variable from input variable "target":
             0 (bakground) : if "target" <= 0.5;
             1 (signal)    : else -->

	<processor id="target_hyp" name="ProcCategory">
		<input>
			<var source="loop" name="target"/>
		</input>
		<config>
			<group><box><range max="0.5"/></box></group>
			<group><box><range/></box></group>
		</config>
		<output>
			<var name="target"/>
		</output>
	</processor>

        <!-- normalize input variables -->

	<xslt-ProcNormalize id="norm" source="loop">
		<xi:include href="SemiLepJetCombMVATrainer_vars.xml"/>
	        <xslt-varlist>
			<var source="target_hyp" name="target" target="true"/>
		</xslt-varlist>
	</xslt-ProcNormalize>

        <!-- combine variables into likelihood -->

	<xslt-ProcLikelihood id="like" source="norm" smooth="3">
	        <xslt-varlist>
			<var source="target_hyp" name="target" target="true"/>
                        <var name="massHadW"/>
                        <var name="deltaThetaHadTopLepB"/>
                        <var name="deltaThetaLepBLepton"/>
                        <var name="relativePtHadronicTop"/>
                        <var name="bTagSumTrkCntHighEff"/>
		</xslt-varlist>
	</xslt-ProcLikelihood>

        <!-- this is just a workaround to get monitoring histograms for the likelihood for each hypothesis-->

	<xslt-ProcNormalize id="norm_monitor_hyp">
	        <xslt-varlist>
			<var source="target_hyp" name="target" target="true"/>
			<var source="like" name="discriminator"/>
	        </xslt-varlist>
	</xslt-ProcNormalize>

        <!-- end of ProcForEach loop -->

        <!-- sort hypotheses w.r.t. the discriminator (second input variable, therefore index="1")
             in descending order, i.e. from the highest discriminator to the lowest -->

	<processor id="sort" name="ProcSort">
		<input>
			<var source="target_hyp" name="target"/>
			<var source="like" name="discriminator"/>
		</input>
		<config>
			<key index="1" descending="true"/>
		</config>
		<output>
			<var name="index"/>
			<var name="target"/>
			<var name="discr"/>
		</output>
	</processor>

        <!-- separate best hypothesis from the rest -->

	<processor id="split_best" name="ProcSplitter">
		<input>
			<var source="sort" name="target"/>
			<var source="sort" name="discr"/>
		</input>
		<config>
			<select first="1"/>
		</config>
		<output>
			<var name="target"/>
			<var name="targetRest"/>
			<var name="discr"/>        <!-- this variable is the final mva output for each event -->
			<var name="discrRest"/>
		</output>
	</processor>

        <!-- create target variable for the event (only for calculating purities and efficiencies):
             0 (background) : best hypothesis was background;
             1 (signal)     : best hypothesis was signal -->

	<processor id="target_evt" name="ProcCategory">
		<input>
			<var source="split_best" name="target"/>
		</input>
		<config>
			<group><box><range max="0.5"/></box></group>
			<group><box><range/></box></group>
		</config>
		<output>
			<var name="target"/>
		</output>
	</processor>

        <!-- this is just a workaround to get monitoring histograms from ProcSplitter -->

	<xslt-ProcNormalize id="norm_monitor_evt">
	        <xslt-varlist>
                        <var source="split_best" name="discr"/>
                        <var source="split_best" name="discrRest"/>
			<var source="target_evt" name="target" target="true"/>
	        </xslt-varlist>
	</xslt-ProcNormalize>

        <!-- final output is the discriminator of the best hypothesis -->

	<output>
		<var source="split_best" name="discr"/>
	</output>

</MVATrainer>
